<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <title>E.V.A. – Ollama UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    textarea { width: 100%; min-height: 120px; font-family: ui-monospace, Consolas, monospace; }
    #output { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; min-height: 160px; border-radius: 8px; background:#fafafa; }
    select, button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; }
    .muted { color:#666; font-size: 0.9rem; }
    .toolbar { display:flex; gap:8px; align-items:center; }
    .link { color: #0a58ca; text-decoration: none; }
  </style>
</head>
<body>
  <h1>E.V.A. – Interfaccia Ollama</h1>

  <div class="row">
    <label for="model">Modello:</label>
    <select id="model">
      {% for m in models %}
        <option value="{{m}}" {% if m==default_model %}selected{% endif %}>{{m}}</option>
      {% endfor %}
    </select>
    <a class="link" href="/config">⚙️ Config</a>
  </div>

  <p class="muted">Scrivi il prompt qui sotto e premi “Invia (stream)”. La risposta arriverà in tempo reale.</p>
  <textarea id="input" placeholder="Scrivi qui..."></textarea>

  <div class="toolbar">
    <button id="sendStream">Invia (stream)</button>
    <button id="sendSync">Invia (sync)</button>
    <button id="clear">Pulisci</button>
  </div>

  <h3>Risposta</h3>
  <div id="output"></div>

  <script>
    const $ = (q) => document.querySelector(q);
    const input = $("#input");
    const output = $("#output");
    const modelSel = $("#model");

    $("#clear").onclick = () => { output.textContent = ""; input.value = ""; input.focus(); };

    // Sync (per compatibilità con vecchi endpoint)
    $("#sendSync").onclick = async () => {
      const query = input.value.trim();
      if (!query) return;
      output.textContent = "⏳ Attendi...";
      const res = await fetch(`/json`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({query, model: modelSel.value})
      });
      const data = await res.json();
      output.textContent = data?.response ?? "(nessuna risposta)";
    };

    // Stream
    $("#sendStream").onclick = async () => {
      const query = input.value.trim();
      if (!query) return;
      output.textContent = "";
      const res = await fetch(`/stream`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({query, model: modelSel.value})
      });
      if (!res.ok || !res.body) {
        output.textContent = `Errore HTTP: ${res.status}`;
        return;
      }
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let done, value;
      while (true) {
        ({done, value} = await reader.read());
        if (done) break;
        output.textContent += decoder.decode(value, { stream: true });
      }
    };
  </script>
</body>
</html>
